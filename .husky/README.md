# Husky Git é’©å­é…ç½®

æœ¬ç›®å½•åŒ…å«äº†é¡¹ç›®çš„ Git é’©å­é…ç½®ï¼Œä½¿ç”¨ [Husky](https://typicode.github.io/husky/) æ¥ç®¡ç†å’Œæ‰§è¡Œè¿™äº›é’©å­ã€‚

## ğŸ¤” ä»€ä¹ˆæ˜¯ Huskyï¼Ÿ

Husky æ˜¯ä¸€ä¸ªç”¨äºç®¡ç† Git é’©å­çš„å·¥å…·ï¼Œå®ƒè®©ä½ å¯ä»¥è½»æ¾åœ°åœ¨ Git æ“ä½œï¼ˆå¦‚æäº¤ã€æ¨é€ï¼‰æ—¶è‡ªåŠ¨è¿è¡Œè„šæœ¬ã€‚è¿™å¯¹äºç»´æŠ¤ä»£ç è´¨é‡å’Œç»Ÿä¸€å¼€å‘æµç¨‹éå¸¸æœ‰ç”¨ã€‚

### Git é’©å­æ˜¯ä»€ä¹ˆï¼Ÿ

Git é’©å­ï¼ˆGit Hooksï¼‰æ˜¯ Git åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨æ‰§è¡Œçš„è„šæœ¬ã€‚æ¯”å¦‚ï¼š

- åœ¨æäº¤ä»£ç å‰è¿è¡Œä»£ç æ£€æŸ¥
- åœ¨æäº¤ä¿¡æ¯å†™å…¥å‰éªŒè¯æ ¼å¼
- åœ¨æ¨é€ä»£ç å‰è¿è¡Œæµ‹è¯•

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Huskyï¼Ÿ

### ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜

- Git åŸç”Ÿé’©å­é…ç½®å¤æ‚ï¼Œä¸æ˜“åˆ†äº«
- æ–°æˆå‘˜åŠ å…¥é¡¹ç›®æ—¶éœ€è¦æ‰‹åŠ¨é…ç½®é’©å­
- é’©å­è„šæœ¬ä¸ä¼šè¢« Git è·Ÿè¸ªï¼Œå®¹æ˜“ä¸¢å¤±

### Husky çš„ä¼˜åŠ¿

- **ç®€å•æ˜“ç”¨**ï¼šé€šè¿‡ç®€å•çš„é…ç½®æ–‡ä»¶ç®¡ç†é’©å­
- **å›¢é˜Ÿå…±äº«**ï¼šé’©å­é…ç½®è·Ÿéšé¡¹ç›®ä¸€èµ·ç‰ˆæœ¬æ§åˆ¶
- **è‡ªåŠ¨å®‰è£…**ï¼šæ–°æˆå‘˜å…‹éš†é¡¹ç›®åè‡ªåŠ¨é…ç½®é’©å­
- **è·¨å¹³å°**ï¼šåœ¨ Windowsã€macOSã€Linux ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ

## ğŸ“‹ é¡¹ç›®ä¸­çš„é’©å­é…ç½®

### 1. `commit-msg` - æäº¤ä¿¡æ¯è§„èŒƒæ£€æŸ¥

**æ–‡ä»¶ä½ç½®**ï¼š`.husky/commit-msg`

**ä½œç”¨**ï¼šéªŒè¯æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆçº¦å®šå¼æäº¤ï¼ˆConventional Commitsï¼‰è§„èŒƒ

**æ‰§è¡Œå†…å®¹**ï¼š

```bash
pnpx commitlint --edit $1
```

**æ£€æŸ¥è§„åˆ™**ï¼š

- `feat: æ·»åŠ æ–°åŠŸèƒ½` âœ… æ­£ç¡®æ ¼å¼
- `fix: ä¿®å¤ç™»å½•é—®é¢˜` âœ… æ­£ç¡®æ ¼å¼
- `éšä¾¿å†™çš„æäº¤ä¿¡æ¯` âŒ é”™è¯¯æ ¼å¼
- `Add new feature` âŒ é”™è¯¯æ ¼å¼ï¼ˆåº”è¯¥ç”¨ä¸­æ–‡æˆ–è§„èŒƒå‰ç¼€ï¼‰

**å¦‚æœæ£€æŸ¥å¤±è´¥**ï¼š

```bash
# æäº¤ä¼šè¢«é˜»æ­¢ï¼Œæ˜¾ç¤ºç±»ä¼¼é”™è¯¯ä¿¡æ¯
â§—   input: éšä¾¿å†™çš„æäº¤ä¿¡æ¯
âœ–   subject may not be empty [subject-empty]
âœ–   type may not be empty [type-empty]
```

### 2. `pre-commit` - æäº¤å‰ä»£ç æ£€æŸ¥

**æ–‡ä»¶ä½ç½®**ï¼š`.husky/pre-commit`

**ä½œç”¨**ï¼šåœ¨ä»£ç æäº¤å‰è‡ªåŠ¨è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥å’Œæ ¼å¼åŒ–

**æ‰§è¡Œé€»è¾‘**ï¼š

```bash
# æ£€æŸ¥å„ä¸ªç›®å½•æ˜¯å¦æœ‰å˜æ›´çš„æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™è¿è¡Œç›¸åº”çš„ lint-staged

ROOT_DIR="$(pwd)"

# å‰ç«¯é¡¹ç›®æ£€æŸ¥
if git diff --cached --name-only | grep -q "^apps/web/"; then
  cd "$ROOT_DIR/apps/web" && pnpx lint-staged
fi

# åç«¯é¡¹ç›®æ£€æŸ¥
if git diff --cached --name-only | grep -q "^apps/service/"; then
  cd "$ROOT_DIR/apps/service" && pnpx lint-staged
fi

# UI ç»„ä»¶åº“æ£€æŸ¥
if git diff --cached --name-only | grep -q "^packages/ui/"; then
  cd "$ROOT_DIR/packages/ui" && pnpx lint-staged
fi

# å…¶ä»–åŒ…çš„æ£€æŸ¥...
```

**æ£€æŸ¥å†…å®¹**ï¼š

- ESLint ä»£ç è´¨é‡æ£€æŸ¥
- Prettier ä»£ç æ ¼å¼åŒ–
- TypeScript ç±»å‹æ£€æŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰

**å¦‚æœæ£€æŸ¥å¤±è´¥**ï¼š

```bash
# æäº¤ä¼šè¢«é˜»æ­¢ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
âœ– eslint --fix:
apps/web/app/routes/home.tsx
  12:5  error  'console' is not defined  no-undef

âœ– lint-staged failed
```

## ğŸ”§ å·¥ä½œåŸç†è¯¦è§£

### 1. å®‰è£…è¿‡ç¨‹

å½“ä½ è¿è¡Œ `pnpm install` æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ `pnpm prepare`ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šï¼š

```bash
# åˆå§‹åŒ– Huskyï¼Œåœ¨ .git/hooks/ ç›®å½•ä¸‹åˆ›å»ºå®é™…çš„é’©å­æ–‡ä»¶
husky
```

### 2. é’©å­æ‰§è¡Œæµç¨‹

#### commit-msg é’©å­æµç¨‹ï¼š

```
ä½ æ‰§è¡Œ git commit -m "æ¶ˆæ¯"
    â†“
Git å‡†å¤‡åˆ›å»ºæäº¤
    â†“
è§¦å‘ commit-msg é’©å­
    â†“
è¿è¡Œ pnpx commitlint --edit $1
    â†“
éªŒè¯æäº¤ä¿¡æ¯æ ¼å¼
    â†“
é€šè¿‡ â†’ ç»§ç»­æäº¤
å¤±è´¥ â†’ é˜»æ­¢æäº¤å¹¶æ˜¾ç¤ºé”™è¯¯
```

#### pre-commit é’©å­æµç¨‹ï¼š

```
ä½ æ‰§è¡Œ git commit
    â†“
Git æ£€æµ‹åˆ°æš‚å­˜åŒºæœ‰æ–‡ä»¶
    â†“
è§¦å‘ pre-commit é’©å­
    â†“
æ£€æŸ¥å“ªäº›é¡¹ç›®æœ‰å˜æ›´çš„æ–‡ä»¶
    â†“
å¯¹åº”é¡¹ç›®è¿è¡Œ lint-staged
    â†“
æ‰§è¡Œ ESLint + Prettier
    â†“
é€šè¿‡ â†’ ç»§ç»­æäº¤
å¤±è´¥ â†’ é˜»æ­¢æäº¤å¹¶æ˜¾ç¤ºé”™è¯¯
```

### 3. lint-staged çš„ä½œç”¨

`lint-staged` æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒåªå¯¹ Git æš‚å­˜åŒºï¼ˆstagedï¼‰çš„æ–‡ä»¶è¿è¡Œæ£€æŸ¥ï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡¹ç›®ã€‚è¿™æ ·å¯ä»¥ï¼š

- åŠ å¿«æ£€æŸ¥é€Ÿåº¦
- åªæ£€æŸ¥ä½ ä¿®æ”¹çš„æ–‡ä»¶
- é¿å…å› å…¶ä»–äººçš„ä»£ç é—®é¢˜è€Œé˜»æ­¢ä½ çš„æäº¤

## ğŸ›  å¦‚ä½•ä½¿ç”¨

### æ­£å¸¸å¼€å‘æµç¨‹

```bash
# 1. ä¿®æ”¹ä»£ç 
vim apps/web/app/routes/home.tsx

# 2. æš‚å­˜æ–‡ä»¶
git add apps/web/app/routes/home.tsx

# 3. æäº¤ï¼ˆä¼šè‡ªåŠ¨è§¦å‘é’©å­æ£€æŸ¥ï¼‰
git commit -m "feat: æ·»åŠ é¦–é¡µæ–°åŠŸèƒ½"

# å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œæäº¤æˆåŠŸ
# å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä¿®å¤é—®é¢˜åé‡æ–°æäº¤
```

### å¤„ç†æ£€æŸ¥å¤±è´¥çš„æƒ…å†µ

**ESLint é”™è¯¯**ï¼š

```bash
# å¦‚æœæ˜¯å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜ï¼Œé’©å­ä¼šè‡ªåŠ¨ä¿®å¤å¹¶é‡æ–°æš‚å­˜
# å¦‚æœæ˜¯éœ€è¦æ‰‹åŠ¨ä¿®å¤çš„é—®é¢˜ï¼Œä½ éœ€è¦ï¼š
1. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œå®šä½é—®é¢˜æ–‡ä»¶
2. ä¿®å¤ä»£ç é—®é¢˜
3. é‡æ–°æš‚å­˜æ–‡ä»¶ï¼šgit add <æ–‡ä»¶å>
4. é‡æ–°æäº¤ï¼šgit commit -m "your message"
```

**æäº¤ä¿¡æ¯æ ¼å¼é”™è¯¯**ï¼š

```bash
# å¦‚æœæäº¤ä¿¡æ¯æ ¼å¼ä¸æ­£ç¡®ï¼š
1. æŸ¥çœ‹é”™è¯¯æç¤º
2. ä½¿ç”¨æ­£ç¡®æ ¼å¼é‡æ–°æäº¤ï¼š
   git commit -m "feat: æ­£ç¡®çš„æäº¤ä¿¡æ¯"
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### æ·»åŠ æ–°çš„ Git é’©å­

å¦‚æœä½ éœ€è¦æ·»åŠ æ–°çš„é’©å­ï¼Œå¯ä»¥ï¼š

```bash
# åˆ›å»ºæ–°çš„é’©å­æ–‡ä»¶
npx husky add .husky/pre-push "npm test"

# è¿™ä¼šåˆ›å»º .husky/pre-push æ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼š
# #!/usr/bin/env sh
# . "$(dirname -- "$0")/_/husky.sh"
# npm test
```

### ä¿®æ”¹ç°æœ‰é’©å­

ç›´æ¥ç¼–è¾‘ `.husky/` ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š

```bash
# ç¼–è¾‘ pre-commit é’©å­
vim .husky/pre-commit

# ç¼–è¾‘ commit-msg é’©å­
vim .husky/commit-msg
```

### è·³è¿‡é’©å­æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰

åœ¨ç´§æ€¥æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥è·³è¿‡é’©å­æ£€æŸ¥ï¼š

```bash
# è·³è¿‡ pre-commit é’©å­
git commit -m "feat: ç´§æ€¥ä¿®å¤" --no-verify

# æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡
HUSKY=0 git commit -m "feat: ç´§æ€¥ä¿®å¤"
```

âš ï¸ **æ³¨æ„**ï¼šè·³è¿‡é’©å­æ£€æŸ¥ä¼šç»•è¿‡ä»£ç è´¨é‡ä¿è¯ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨ã€‚

## â“ å¸¸è§é—®é¢˜

### 1. Husky é’©å­æ²¡æœ‰æ‰§è¡Œï¼Ÿ

**å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. ç¡®è®¤ Husky å·²æ­£ç¡®å®‰è£…
pnpm run prepare

# 2. æ£€æŸ¥ .git/hooks/ ç›®å½•ä¸‹æ˜¯å¦æœ‰é’©å­æ–‡ä»¶
ls -la .git/hooks/

# 3. ç¡®è®¤é’©å­æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
chmod +x .git/hooks/*
```

### 2. é’©å­æ‰§è¡Œå¾ˆæ…¢ï¼Ÿ

**ä¼˜åŒ–å»ºè®®**ï¼š

- lint-staged åªæ£€æŸ¥æš‚å­˜æ–‡ä»¶ï¼Œç¡®ä¿é…ç½®æ­£ç¡®
- è€ƒè™‘è°ƒæ•´ ESLint è§„åˆ™ï¼Œç§»é™¤è€—æ—¶çš„æ£€æŸ¥
- ä½¿ç”¨æ›´å¿«çš„å·¥å…·æ›¿ä»£ï¼ˆå¦‚ç”¨ swc æ›¿ä»£ babelï¼‰

### 3. æ–°æˆå‘˜çš„ç”µè„‘ä¸Šé’©å­ä¸å·¥ä½œï¼Ÿ

**è§£å†³æ­¥éª¤**ï¼š

```bash
# æ–°æˆå‘˜éœ€è¦æ‰§è¡Œ
pnpm install
pnpm run prepare

# å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œæ‰‹åŠ¨é‡æ–°å®‰è£… Husky
rm -rf .git/hooks/
pnpm run prepare
```

### 4. æƒ³è¦ç¦ç”¨æŸä¸ªé’©å­ï¼Ÿ

```bash
# ä¸´æ—¶ç¦ç”¨ï¼ˆé‡æ–°å®‰è£…ä¼šæ¢å¤ï¼‰
rm .git/hooks/pre-commit

# æ°¸ä¹…ç¦ç”¨ï¼ˆåˆ é™¤é…ç½®æ–‡ä»¶ï¼‰
rm .husky/pre-commit
```

## ğŸ“š ç›¸å…³èµ„æ–™

- [Husky å®˜æ–¹æ–‡æ¡£](https://typicode.github.io/husky/)
- [Conventional Commits è§„èŒƒ](https://www.conventionalcommits.org/)
- [lint-staged æ–‡æ¡£](https://github.com/okonet/lint-staged)
- [commitlint é…ç½®æŒ‡å—](https://commitlint.js.org/)
